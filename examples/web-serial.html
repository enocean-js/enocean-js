<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
    <style>
      div{background: url(tilegroup.svg);width:100vw;height:100vh}
    </style>
  </head>
  <body>
    <button id="btn1">click</button>
    <script type="module">
      import * as Enocean from '../packages/enocean.js'
      const RadioERP1 = Enocean.RadioERP1
      const ESP3Parser = Enocean.ESP3WebSerialParser
      const parser = new ESP3Parser()

      const requestSerial = async ()=>{
        navigator.serial.addEventListener("connect",e=>{console.log("connected")})
        let ports = await navigator.serial.getPorts()
        if(ports.length > 0){
          await ports[0].open({baudrate: 57600})
          const reader = ports[0].readable.getReader();
          console.log("listening")
          await parser.read(reader)
        }else{
          const port = await navigator.serial.requestPort();

        }
      }
      window.addEventListener("load", requestSerial)
      btn1.addEventListener("load", requestSerial)
      
      let known = []

      parser.addEventListener("data",evt=>{
        Enocean.pretty.logESP3(evt.detail)
        const data = evt.detail
        if(data.senderId in known){
          console.log("found",known[data.senderId])
          let decoded = data.decode(known[data.senderId].eep.toString())
          console.log(decoded)
        }else{
          console.log("unknown")
          if(data.teachIn){
            known[data.senderId] = data.teachInInfo
            console.log("learned", data.teachInInfo)
          }
        }
      })



    </script>
    <div>
    </div>
  </body>
</html>
